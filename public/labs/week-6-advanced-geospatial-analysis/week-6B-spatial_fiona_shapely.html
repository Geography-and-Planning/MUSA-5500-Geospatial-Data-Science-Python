<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.40">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Week-6B-Using Fiona to manipuate shapefiles and do spatial analysis</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="week-6B-spatial_fiona_shapely_files/libs/clipboard/clipboard.min.js"></script>
<script src="week-6B-spatial_fiona_shapely_files/libs/quarto-html/quarto.js"></script>
<script src="week-6B-spatial_fiona_shapely_files/libs/quarto-html/popper.min.js"></script>
<script src="week-6B-spatial_fiona_shapely_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="week-6B-spatial_fiona_shapely_files/libs/quarto-html/anchor.min.js"></script>
<link href="week-6B-spatial_fiona_shapely_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="week-6B-spatial_fiona_shapely_files/libs/quarto-html/quarto-syntax-highlighting-549806ee2085284f45b00abea8c6df48.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="week-6B-spatial_fiona_shapely_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="week-6B-spatial_fiona_shapely_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="week-6B-spatial_fiona_shapely_files/libs/bootstrap/bootstrap-81e35ebdb4125010edbabe6010586085.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">


</head>

<body>

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article toc-left">
<div id="quarto-sidebar-toc-left" class="sidebar toc-left">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#python-spaital-ecosystem" id="toc-python-spaital-ecosystem" class="nav-link active" data-scroll-target="#python-spaital-ecosystem"><span class="header-section-number">1</span> Python spaital ecosystem</a>
  <ul class="collapse">
  <li><a href="#popular-python-modules" id="toc-popular-python-modules" class="nav-link" data-scroll-target="#popular-python-modules"><span class="header-section-number">1.1</span> Popular Python modules</a></li>
  <li><a href="#read-the-metadata-of-shapefiles-using-fiona" id="toc-read-the-metadata-of-shapefiles-using-fiona" class="nav-link" data-scroll-target="#read-the-metadata-of-shapefiles-using-fiona"><span class="header-section-number">1.2</span> Read the metadata of shapefiles using fiona</a></li>
  </ul></li>
  <li><a href="#topic-of-today" id="toc-topic-of-today" class="nav-link" data-scroll-target="#topic-of-today"><span class="header-section-number">2</span> Topic of today</a>
  <ul class="collapse">
  <li><a href="#this-session-will-include-some-major-sections" id="toc-this-session-will-include-some-major-sections" class="nav-link" data-scroll-target="#this-session-will-include-some-major-sections"><span class="header-section-number">2.1</span> This session will include some major sections,</a></li>
  <li><a href="#create-a-buffer-of-the-shape" id="toc-create-a-buffer-of-the-shape" class="nav-link" data-scroll-target="#create-a-buffer-of-the-shape"><span class="header-section-number">2.2</span> create a buffer of the shape</a></li>
  <li><a href="#overlap-analysis-using-fionashapely" id="toc-overlap-analysis-using-fionashapely" class="nav-link" data-scroll-target="#overlap-analysis-using-fionashapely"><span class="header-section-number">2.3</span> Overlap analysis using fiona+shapely</a></li>
  <li><a href="#rtree" id="toc-rtree" class="nav-link" data-scroll-target="#rtree"><span class="header-section-number">2.4</span> RTree</a></li>
  <li><a href="#zonal-statistics-using-geopandasrasterio" id="toc-zonal-statistics-using-geopandasrasterio" class="nav-link" data-scroll-target="#zonal-statistics-using-geopandasrasterio"><span class="header-section-number">2.5</span> Zonal statistics using geopandas+rasterio</a></li>
  </ul></li>
  </ul>
</nav>
</div>
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar zindex-bottom">
</div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Week-6B-Using Fiona to manipuate shapefiles and do spatial analysis</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<div id="cell-0" class="cell" data-execution_count="1">
<details class="code-fold">
<summary>Show Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># !pip install pyproj</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Requirement already satisfied: pyproj in /Users/senseablecity/anaconda3/envs/geospatial/lib/python3.9/site-packages (2.6.1.post1)</code></pre>
</div>
</div>
<section id="python-spaital-ecosystem" class="level2" data-number="1">
<h2 data-number="1" class="anchored" data-anchor-id="python-spaital-ecosystem"><span class="header-section-number">1</span> Python spaital ecosystem</h2>
<section id="popular-python-modules" class="level3" data-number="1.1">
<h3 data-number="1.1" class="anchored" data-anchor-id="popular-python-modules"><span class="header-section-number">1.1</span> Popular Python modules</h3>
<p>The following Python modules are widely used in the spatial ecosystem: <img src="week-6B-spatial_fiona_shapely_files/figure-html/cell-2-1-image-2.png" class="img-fluid" alt="image-2.png"></p>
<p>We have already covered some of these modules in the previous weeks, such as <code>geopandas</code>, <code>rasterio</code>, and <code>pyproj</code>. Different modules are at different levels of the spatial data processing pipeline. For example, <code>geopandas</code> is a high-level library that provides a user-friendly interface for working with geospatial data, while <code>rasterio</code> is used for reading and writing raster data. <code>pyproj</code> is a library for performing coordinate transformations and projections.</p>
<p>You can use <code>geopandas</code> to read shapefiles, but it is not the only option. Also sometimes, you may find the <code>geopandas</code> report some weird error messages when you try to read shapefiles. This is because <code>geopandas</code> is built on top of <code>Fiona</code> and <code>Shapely</code>, which are lower-level libraries that provide more control over the reading and writing of shapefiles.</p>
<p>Here we will focus on <code>Fiona</code> and <code>Shapely</code>, which are powerful libraries for reading, writing, and manipulating shapefiles and geometric objects. More importantly, you will be able to understand the underlying mechanisms of how shapefiles are read and written, which will help you troubleshoot any issues you may encounter when working with <code>geopandas</code>.</p>
<p><img src="week-6B-spatial_fiona_shapely_files/figure-html/cell-2-2-image.png" class="img-fluid"></p>
<p><code>Fiona</code> is used for reading and writing vector files (here we’re using Shapefiles), while <code>Shapely</code> is used for doing the manipulation and analysis of the geometric objects.</p>
</section>
<section id="read-the-metadata-of-shapefiles-using-fiona" class="level3" data-number="1.2">
<h3 data-number="1.2" class="anchored" data-anchor-id="read-the-metadata-of-shapefiles-using-fiona"><span class="header-section-number">1.2</span> Read the metadata of shapefiles using fiona</h3>
<div id="cell-4" class="cell" data-execution_count="43">
<details class="code-fold">
<summary>Show Code</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># get the meta data of shapefile, such as spatial reference, field names, etc</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> fiona</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> fiona.crs <span class="im">import</span> to_string</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> shapely.geometry <span class="im">import</span> mapping, shape</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="co"># you can read the shapefile as well</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>census_shp <span class="op">=</span> <span class="st">'data/zillow_neighborhoods.geojson'</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> fiona.<span class="bu">open</span>(census_shp, <span class="st">'r'</span>) <span class="im">as</span> nb_lyr:</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>    driver <span class="op">=</span> nb_lyr.driver <span class="co"># the driver of the shapefile</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>    schema <span class="op">=</span> nb_lyr.schema  <span class="co">#schema of shapefile</span></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>    crs <span class="op">=</span> nb_lyr.crs   <span class="co"># coordinate reference system of the shapefile</span></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>    meta <span class="op">=</span> nb_lyr.meta <span class="co"># more details about the metadata of the shapefile</span></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>    </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
</section>
<section id="topic-of-today" class="level2" data-number="2">
<h2 data-number="2" class="anchored" data-anchor-id="topic-of-today"><span class="header-section-number">2</span> Topic of today</h2>
<section id="this-session-will-include-some-major-sections" class="level3" data-number="2.1">
<h3 data-number="2.1" class="anchored" data-anchor-id="this-session-will-include-some-major-sections"><span class="header-section-number">2.1</span> This session will include some major sections,</h3>
<ol type="1">
<li><p>Read metadata, attributes, geometry of features in shapfile using fiona</p></li>
<li><p>Create shapefile based on the longitude and latitude</p></li>
<li><p>Do buffer analysis using fiona+shapely</p></li>
<li><p>Do intersection of point feature class and polygon feature class</p></li>
<li><p>Do zonal statistics using fiona+shapely+rasterio</p></li>
</ol>
<p><strong>References</strong>:</p>
<ul>
<li><p>Fiona Manual, <a href="http://toblerity.org/fiona/manual.html">http://toblerity.org/fiona/manual.html</a></p></li>
<li><p>Shapely Manual, <a href="http://toblerity.org/shapely/manual.html">http://toblerity.org/shapely/manual.html</a></p></li>
<li><p>AZAVEA Research Blog, Using Shapely and Fiona to Locate High-Risk Traffic Areas, <a href="https://www.azavea.com/blog/2016/10/05/philippines-road-safety-using-shapely-fiona-locate-high-risk-traffic-areas/">https://www.azavea.com/blog/2016/10/05/philippines-road-safety-using-shapely-fiona-locate-high-risk-traffic-areas/</a></p></li>
</ul>
<p>Let’s take a look at what those metadata look like</p>
<div id="cell-7" class="cell" data-execution_count="3">
<details class="code-fold">
<summary>Show Code</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span> (<span class="st">'The driver is:'</span>, driver)</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span> (<span class="st">'The schema is:'</span>, schema)</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span> (<span class="st">'The coordinate reference system is:'</span>, crs)</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span> (<span class="st">'the metadata is:'</span>, meta)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>The driver is: GeoJSON
The schema is: {'properties': {'ZillowName': 'str'}, 'geometry': 'Polygon'}
The coordinate reference system is: EPSG:4326
the metadata is: {'driver': 'GeoJSON', 'schema': {'properties': {'ZillowName': 'str'}, 'geometry': 'Polygon'}, 'crs': CRS.from_epsg(4326), 'crs_wkt': 'GEOGCS["WGS 84",DATUM["WGS_1984",SPHEROID["WGS 84",6378137,298.257223563,AUTHORITY["EPSG","7030"]],AUTHORITY["EPSG","6326"]],PRIMEM["Greenwich",0,AUTHORITY["EPSG","8901"]],UNIT["degree",0.0174532925199433,AUTHORITY["EPSG","9122"]],AXIS["Latitude",NORTH],AXIS["Longitude",EAST],AUTHORITY["EPSG","4326"]]'}</code></pre>
</div>
</div>
<p>We can check the geometry and attribute of all features (polygons in this case) in shapefile.</p>
<div id="cell-9" class="cell" data-execution_count="44">
<details class="code-fold">
<summary>Show Code</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> fiona.<span class="bu">open</span>(census_shp, <span class="st">'r'</span>) <span class="im">as</span> nb_lyr:</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> feat <span class="kw">in</span> nb_lyr:</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>        <span class="co"># attribute of the neighborhood features</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>        attr <span class="op">=</span> feat[<span class="st">'properties'</span>]</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>        name <span class="op">=</span> attr[<span class="st">'ZillowName'</span>]  <span class="co">#you can find other attribute based on the metadata of the shapefile</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span> (<span class="st">'The neighborhod is:'</span>, name)</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>        <span class="co"># get the geometry of the polygon feature</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>        geom <span class="op">=</span> feat[<span class="st">'geometry'</span>]</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a><span class="co">#         print ('geom is:', geom)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>The neighborhod is: Academy Gardens
The neighborhod is: Airport
The neighborhod is: Allegheny West
The neighborhod is: Andorra
The neighborhod is: Aston Woodbridge
The neighborhod is: Bartram Village
The neighborhod is: Bella Vista
The neighborhod is: Belmont
The neighborhod is: Brewerytown
The neighborhod is: Bridesburg
The neighborhod is: Burnholme
The neighborhod is: Bustleton
The neighborhod is: Byberry
The neighborhod is: Callow Hill
The neighborhod is: Carroll Park
The neighborhod is: Cedar Park
The neighborhod is: Cedarbrook
The neighborhod is: Center City
The neighborhod is: Chestnut Hill
The neighborhod is: Chinatown
The neighborhod is: Clearview
The neighborhod is: Cobbs Creek
The neighborhod is: Crescentville
The neighborhod is: Crestmont Farms
The neighborhod is: Dearnley Park
The neighborhod is: Dickinson Narrows
The neighborhod is: Dunlap
The neighborhod is: East Falls
The neighborhod is: East Kensington
The neighborhod is: East Oak Lane
The neighborhod is: East Park
The neighborhod is: East Parkside
The neighborhod is: East Passyunk
The neighborhod is: East Poplar
The neighborhod is: Eastwick
The neighborhod is: Elmwood
The neighborhod is: Fairhill
The neighborhod is: Fairmount
The neighborhod is: Feltonville
The neighborhod is: Fern Rock
The neighborhod is: Fishtown
The neighborhod is: Fitler Square
The neighborhod is: Fox Chase
The neighborhod is: Francisville
The neighborhod is: Frankford
The neighborhod is: Franklin Mills
The neighborhod is: Franklinville
The neighborhod is: Garden Court
The neighborhod is: Germantown East
The neighborhod is: Germantown Morton
The neighborhod is: Germantown Penn Knox
The neighborhod is: Germantown Southwest
The neighborhod is: Germantown West Central
The neighborhod is: Germantown Westside
The neighborhod is: Germany Hill
The neighborhod is: Girard Estates
The neighborhod is: Glenwood
The neighborhod is: Graduate Hospital
The neighborhod is: Grays Ferry
The neighborhod is: Greenwich
The neighborhod is: Haddington
The neighborhod is: Harrowgate
The neighborhod is: Hartranft
The neighborhod is: Haverford North
The neighborhod is: Hawthorne
The neighborhod is: Holmesburg
The neighborhod is: Hunting Park
The neighborhod is: Industrial
The neighborhod is: Juniata Park
The neighborhod is: Kingesessing
The neighborhod is: Lawndale
The neighborhod is: Lexington Park
The neighborhod is: Logan
The neighborhod is: Logan Square
The neighborhod is: Lower Moyamensing
The neighborhod is: Ludlow
The neighborhod is: Manayunk
The neighborhod is: Mantua
The neighborhod is: Mayfair
The neighborhod is: McGuire
The neighborhod is: Mechanicsville
The neighborhod is: Melrose Park Gardens
The neighborhod is: Mill Creek
The neighborhod is: Millbrook
The neighborhod is: Modena
The neighborhod is: Morrell Park
The neighborhod is: Mount Airy East
The neighborhod is: Mount Airy West
The neighborhod is: Navy Yard
The neighborhod is: Newbold
The neighborhod is: Nicetown
The neighborhod is: Normandy Village
The neighborhod is: North Central
The neighborhod is: Northeast Airport
The neighborhod is: Northern Liberties
The neighborhod is: Northwood
The neighborhod is: Ogontz
The neighborhod is: Old City
The neighborhod is: Old Kensington
The neighborhod is: Olney
The neighborhod is: Overbrook
The neighborhod is: Oxford Circle
The neighborhod is: Packer Park
The neighborhod is: Parkwood Manor
The neighborhod is: Paschall
The neighborhod is: Passyunk Square
The neighborhod is: Pennsport
The neighborhod is: Pennypack
The neighborhod is: Pennypack Park
The neighborhod is: Pennypack Woods
The neighborhod is: Penrose
The neighborhod is: Point Breeze
The neighborhod is: Port Richmond
The neighborhod is: Powelton
The neighborhod is: Queen Village
The neighborhod is: Rhawnhurst
The neighborhod is: Richmond
The neighborhod is: Rittenhouse
The neighborhod is: Riverfront
The neighborhod is: Roxborough
The neighborhod is: Roxborough Park
The neighborhod is: Sharswood
The neighborhod is: Society Hill
The neighborhod is: Somerton
The neighborhod is: Southwest Schuylkill
The neighborhod is: Spring Garden
The neighborhod is: Spruce Hill
The neighborhod is: Stadium District
The neighborhod is: Stanton
The neighborhod is: Strawberry Mansion
The neighborhod is: Summerdale
The neighborhod is: Tacony
The neighborhod is: Tioga
The neighborhod is: Torresdale
The neighborhod is: University City
The neighborhod is: Upper Kensington
The neighborhod is: Upper Roxborough
The neighborhod is: Walnut Hill
The neighborhod is: Washington Square
The neighborhod is: West Kensington
The neighborhod is: West Oak Lane
The neighborhod is: West Park
The neighborhod is: West Parkside
The neighborhod is: West Passyunk
The neighborhod is: West Poplar
The neighborhod is: West Powelton
The neighborhod is: West Torresdale
The neighborhod is: Whitman
The neighborhod is: Winchester Park
The neighborhod is: Wissahickon
The neighborhod is: Wissahickon Hills
The neighborhod is: Wissahickon Park
The neighborhod is: Wissinoming
The neighborhod is: Wister
The neighborhod is: Woodland Terrace
The neighborhod is: Wynnefield
The neighborhod is: Wynnefield Heights
The neighborhod is: Yorktown</code></pre>
</div>
</div>
<p>If you don’t like the <code>with</code> statement, you can also use the following code to read the shapefile:</p>
<div id="cell-11" class="cell" data-execution_count="45">
<details class="code-fold">
<summary>Show Code</summary>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>nb_lyr <span class="op">=</span> fiona.<span class="bu">open</span>(census_shp, <span class="st">'r'</span>)</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> feat <span class="kw">in</span> nb_lyr:</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>    <span class="co"># attribute of the neighborhood features</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>    attr <span class="op">=</span> feat[<span class="st">'properties'</span>]</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>    name <span class="op">=</span> attr[<span class="st">'ZillowName'</span>]  <span class="co">#you can find other attribute based on the metadata of the shapefile</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># get the geometry of the polygon feature</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>    geom <span class="op">=</span> feat[<span class="st">'geometry'</span>]</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a><span class="co">#         print ('geom is:', geom)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>We can convert the dictionary <code>geom</code> variable into a shapely Polygon object using shapely. Here is one example of using shapely to deal with the geometry of features in shapefile.</p>
<div id="cell-13" class="cell" data-scrolled="true" data-execution_count="5">
<details class="code-fold">
<summary>Show Code</summary>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># the shape is a function in shapely, we import "from shapely.geometry import shape"</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>shape(geom)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="5">
<div>
<figure class="figure">
<p><img src="week-6B-spatial_fiona_shapely_files/figure-html/cell-7-output-1.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="create-a-buffer-of-the-shape" class="level3" data-number="2.2">
<h3 data-number="2.2" class="anchored" data-anchor-id="create-a-buffer-of-the-shape"><span class="header-section-number">2.2</span> create a buffer of the shape</h3>
<p>The projection is wgs84, and the unit is degree, so be careful for the buffer analysis. If you want to do buffer analysis, you need to convert the projection to a projected coordinate system, such as UTM, which uses meters as the unit. Here is a demostration of using a small number for buffer analysis.</p>
<div id="cell-16" class="cell" data-scrolled="true" data-execution_count="6">
<details class="code-fold">
<summary>Show Code</summary>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>buff_geom <span class="op">=</span> shape(geom).<span class="bu">buffer</span>(<span class="fl">0.001</span>) <span class="co">#1 degree is a long distance</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>buff_geom</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="co"># mapping(shape(point['geometry']).buffer(5.0))</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="6">
<div>
<figure class="figure">
<p><img src="week-6B-spatial_fiona_shapely_files/figure-html/cell-8-output-1.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p><strong>Note</strong> Make sure your shapefile is in a projected coordinate system before you do buffer analysis. Like using the local projection with unit of feet or meters if you want to do buffer analysis.</p>
</section>
<section id="overlap-analysis-using-fionashapely" class="level3" data-number="2.3">
<h3 data-number="2.3" class="anchored" data-anchor-id="overlap-analysis-using-fionashapely"><span class="header-section-number">2.3</span> Overlap analysis using fiona+shapely</h3>
<p>We may want to find out which points fall within which polygons. This is a common spatial analysis task known as a point-in-polygon query. It can also apply to other geometry types, such as lines and polygons, points and lines, etc.</p>
<p>However, because of the huge amount of combination for seaching, it may take a long time to finish the analysis. We need to think about how to optimize the code to speed up the analysis.</p>
<p>For example, you want to find a book with name of “Python for Geospatial Data Science” in a library with 1 million books. If you search the book one by one, it will take a long time to finish the search. But if you search the index of the book first, it will be much faster. Similarly, for spatial analysis, we can use spatial indexing to speed up the search process.</p>
</section>
<section id="rtree" class="level3" data-number="2.4">
<h3 data-number="2.4" class="anchored" data-anchor-id="rtree"><span class="header-section-number">2.4</span> RTree</h3>
<p>RTree is a spatial indexing library that can be used to speed up spatial queries. It works by creating a hierarchical structure of bounding boxes that can be used to quickly eliminate large portions of the search space.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="week-6B-spatial_fiona_shapely_files/figure-html/cell-21-1-4f125daf-413b-4364-90e2-fa222ed6d670.png" class="img-fluid figure-img" width="200"></p>
<figcaption>image.png</figcaption>
</figure>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="week-6B-spatial_fiona_shapely_files/figure-html/cell-21-2-image.png" class="img-fluid figure-img" width="400"></p>
<figcaption>{image.png}</figcaption>
</figure>
</div>
<p>Here is a simple example of find the amount of tree points within each census tract polygon.</p>
<div id="cell-23" class="cell" data-execution_count="9">
<details class="code-fold">
<summary>Show Code</summary>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co"># !pip install rtree</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<section id="create-spatial-index-for-point-features" class="level4" data-number="2.4.1">
<h4 data-number="2.4.1" class="anchored" data-anchor-id="create-spatial-index-for-point-features"><span class="header-section-number">2.4.1</span> Create spatial index for point features</h4>
<p>The two shapefiles are in projection of WGS84, which uses degree as the unit. You can overlay them in Desktop GIS software. But, when do the spatial analysis, you need to convert them into a projected coordinate system, such as UTM, which uses meters as the unit. Here you can reproject both of then to a local projection (epsgcode: 2272) with unit of feet or meters if you want to do buffer analysis.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="week-6B-spatial_fiona_shapely_files/figure-html/cell-24-1-image.png" class="img-fluid figure-img"></p>
<figcaption>image.png</figcaption>
</figure>
</div>
<p>The <a href="data/zillow_nb.geojson">neighborhood polygon</a> and the <a href="data/tree_site.geojson">tree points</a> are in the same projection, so we can do the spatial analysis directly.</p>
</section>
<section id="prepare-the-polygon-features-and-build-empty-rtree-index" class="level4" data-number="2.4.2">
<h4 data-number="2.4.2" class="anchored" data-anchor-id="prepare-the-polygon-features-and-build-empty-rtree-index"><span class="header-section-number">2.4.2</span> prepare the polygon features and build empty RTree index</h4>
<div id="cell-27" class="cell" data-execution_count="6">
<details class="code-fold">
<summary>Show Code</summary>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> rtree</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="co"># neighborhood_map = 'data/zillow_neighborhoods.geojson'</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="co"># treesite_map = 'data/ppr_tree_canopy_points_2015.geojson'</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>neighborhood_map <span class="op">=</span> <span class="st">'data/zillow_nb.geojson'</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>treesite_map <span class="op">=</span> <span class="st">'data/tree_site.geojson'</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>outPolygonShp <span class="op">=</span> <span class="st">'data/trees_neighborhood.shp'</span></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>pnt_lyr <span class="op">=</span> fiona.<span class="bu">open</span>(treesite_map, <span class="st">'r'</span>)     </span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a><span class="co"># create an empty spatial index object</span></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>index <span class="op">=</span> rtree.index.Index()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="populate-the-spatial-index-with-point-features" class="level4" data-number="2.4.3">
<h4 data-number="2.4.3" class="anchored" data-anchor-id="populate-the-spatial-index-with-point-features"><span class="header-section-number">2.4.3</span> Populate the spatial index with point features</h4>
<div id="cell-29" class="cell" data-execution_count="4">
<details class="code-fold">
<summary>Show Code</summary>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co"># populate the spatial index, the polygon features</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>i <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> fid, feature <span class="kw">in</span> pnt_lyr.items():</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>    i <span class="op">=</span> i <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> i <span class="op">%</span> <span class="dv">1000</span> <span class="op">==</span> <span class="dv">0</span>: <span class="bu">print</span> (i)</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>    geometry <span class="op">=</span> shape(feature[<span class="st">'geometry'</span>])</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># add a buffer in order to create a r-tree</span></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>    geometry_buffered <span class="op">=</span> geometry.<span class="bu">buffer</span>(<span class="fl">0.0001</span>) <span class="co"># buffer 0.0001 degree, about 11 meters</span></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>    geotype <span class="op">=</span> feature[<span class="st">'geometry'</span>][<span class="st">'type'</span>]</span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>    index.insert(fid, geometry_buffered.bounds)</span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a><span class="dv">10000</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>1000
2000</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="4">
<pre><code>10000</code></pre>
</div>
</div>
</section>
<section id="start-the-overlay-based-on-the-built-rtree" class="level4" data-number="2.4.4">
<h4 data-number="2.4.4" class="anchored" data-anchor-id="start-the-overlay-based-on-the-built-rtree"><span class="header-section-number">2.4.4</span> Start the overlay based on the built rtree</h4>
<p>There are two steps to do the overlay analysis, step 1. using the rtree index to find the candidate points that may fall within the polygon; step 2. using shapely to check if the candidate points really fall within the polygon.</p>
<div id="cell-31" class="cell" data-execution_count="8">
<details class="code-fold">
<summary>Show Code</summary>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co"># loop all polygons and assign GVI values</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> fiona.<span class="bu">open</span>(neighborhood_map, <span class="st">'r'</span>) <span class="im">as</span> polygon_lyr:</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>    schema <span class="op">=</span> polygon_lyr.schema.copy()</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>    schema[<span class="st">'properties'</span>][<span class="st">'tree_num'</span>]<span class="op">=</span><span class="st">'int'</span> </span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>    input_crs <span class="op">=</span> polygon_lyr.crs</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># write the intersected point into the new shapefile</span></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> fiona.<span class="bu">open</span>(outPolygonShp, <span class="st">'w'</span>, <span class="st">'ESRI Shapefile'</span>, schema, input_crs) <span class="im">as</span> output:</span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>        <span class="co"># loop the polygon feature</span></span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> idx, featPoly <span class="kw">in</span> <span class="bu">enumerate</span>(polygon_lyr):</span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> idx <span class="op">%</span> <span class="dv">100</span> <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="st">'Polygon:'</span>, idx)</span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a>            geomPoly <span class="op">=</span> shape(featPoly[<span class="st">'geometry'</span>])                </span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a>            attriPoly <span class="op">=</span> featPoly[<span class="st">'properties'</span>]</span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a>            <span class="co"># using the bounding box to find the close but may not intersected point feature</span></span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a>            fids <span class="op">=</span> [<span class="bu">int</span>(i) <span class="cf">for</span> i <span class="kw">in</span> index.intersection(geomPoly.bounds)]</span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a>            <span class="co"># print("i have narrowed down to ", len(fids))</span></span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb16-22"><a href="#cb16-22" aria-hidden="true" tabindex="-1"></a>            <span class="co"># count the number of accidents</span></span>
<span id="cb16-23"><a href="#cb16-23" aria-hidden="true" tabindex="-1"></a>            count <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb16-24"><a href="#cb16-24" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb16-25"><a href="#cb16-25" aria-hidden="true" tabindex="-1"></a>            <span class="co"># loop all features in bounding box and then judge if they are intersected</span></span>
<span id="cb16-26"><a href="#cb16-26" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> fid <span class="kw">in</span> fids:</span>
<span id="cb16-27"><a href="#cb16-27" aria-hidden="true" tabindex="-1"></a>                featPnt <span class="op">=</span> pnt_lyr[fid]</span>
<span id="cb16-28"><a href="#cb16-28" aria-hidden="true" tabindex="-1"></a>                geomPnt <span class="op">=</span> shape(featPnt[<span class="st">'geometry'</span>])</span>
<span id="cb16-29"><a href="#cb16-29" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb16-30"><a href="#cb16-30" aria-hidden="true" tabindex="-1"></a>                <span class="co"># if the point is intersected with the polygon, then save the point feature into the output shapefile</span></span>
<span id="cb16-31"><a href="#cb16-31" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> geomPoly.contains(geomPnt): <span class="co">#intersect</span></span>
<span id="cb16-32"><a href="#cb16-32" aria-hidden="true" tabindex="-1"></a>                    count <span class="op">=</span> count <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb16-33"><a href="#cb16-33" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb16-34"><a href="#cb16-34" aria-hidden="true" tabindex="-1"></a>            attriPoly[<span class="st">'tree_num'</span>]<span class="op">=</span>count</span>
<span id="cb16-35"><a href="#cb16-35" aria-hidden="true" tabindex="-1"></a>            output.write({<span class="st">'geometry'</span>: mapping(geomPoly),<span class="st">'properties'</span>: attriPoly})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Polygon: 0
Polygon: 100</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>/var/folders/7g/px0llbj54z37p076r6853ggh0000gn/T/ipykernel_83312/4118696468.py:34: FionaDeprecationWarning: instances of this class -- CRS, geometry, and feature objects -- will become immutable in fiona version 2.0
  attriPoly['tree_num']=count</code></pre>
</div>
</div>
</section>
</section>
<section id="zonal-statistics-using-geopandasrasterio" class="level3" data-number="2.5">
<h3 data-number="2.5" class="anchored" data-anchor-id="zonal-statistics-using-geopandasrasterio"><span class="header-section-number">2.5</span> Zonal statistics using geopandas+rasterio</h3>
<p>We have discussed about using the <code>zonalstats</code> to do the zonal statistics in Week-5B. Here we will demonstrate how to do the zonal statistics using <code>geopandas</code> and <code>rasterio</code>. You will have more control of the process using this method.</p>
<section id="prepare-the-input-data" class="level4" data-number="2.5.1">
<h4 data-number="2.5.1" class="anchored" data-anchor-id="prepare-the-input-data"><span class="header-section-number">2.5.1</span> Prepare the input data</h4>
<p>You will need to prepare the raster data and the shapefile. Also, make sure they are in the same projection. It is easier to reproject the shapefile match with the raster data, because the raster data is usually large and it is time consuming to reproject the raster data.</p>
<div id="cell-35" class="cell" data-execution_count="46">
<details class="code-fold">
<summary>Show Code</summary>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> geopandas <span class="im">as</span> gpd</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Read the GeoJSON</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>neighborhood_map <span class="op">=</span> <span class="st">'data/zillow_nb.geojson'</span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>gdf <span class="op">=</span> gpd.read_file(neighborhood_map)</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Check the current CRS</span></span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(gdf.crs)</span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Reproject to EPSG:32618 to match with the raster data</span></span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a>gdf_utm <span class="op">=</span> gdf.to_crs(epsg<span class="op">=</span><span class="dv">32618</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>EPSG:2272</code></pre>
</div>
</div>
</section>
<section id="conduct-the-zonal-statistics" class="level4" data-number="2.5.2">
<h4 data-number="2.5.2" class="anchored" data-anchor-id="conduct-the-zonal-statistics"><span class="header-section-number">2.5.2</span> Conduct the zonal statistics</h4>
<p>Here we will loop through each polygon in the shapefile, and for each polygon, we will mask the raster data using the polygon, and then calculate the statistics of the masked raster data. Different from the <code>zonalstats</code> module, you will be able to control the statistics you want to calculate, such as mean, median, min, max, std, etc.</p>
<div id="cell-37" class="cell" data-execution_count="72">
<details class="code-fold">
<summary>Show Code</summary>
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> geopandas <span class="im">as</span> gpd</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> rasterio</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> rasterio.mask <span class="im">import</span> mask</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> calculate_NDVI(nir, red):</span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a><span class="co">    Calculate the NDVI from the NIR and red landsat bands</span></span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Convert to floats</span></span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>    nir <span class="op">=</span> nir.astype(<span class="bu">float</span>)</span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a>    red <span class="op">=</span> red.astype(<span class="bu">float</span>)</span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get valid entries</span></span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a>    check <span class="op">=</span> np.logical_and(red.mask <span class="op">==</span> <span class="va">False</span>, nir.mask <span class="op">==</span> <span class="va">False</span>)</span>
<span id="cb21-19"><a href="#cb21-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-20"><a href="#cb21-20" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Where the check is True, return the NDVI, else return NaN</span></span>
<span id="cb21-21"><a href="#cb21-21" aria-hidden="true" tabindex="-1"></a>    ndvi <span class="op">=</span> np.where(check, (nir <span class="op">-</span> red) <span class="op">/</span> (nir <span class="op">+</span> red), np.nan)</span>
<span id="cb21-22"><a href="#cb21-22" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb21-23"><a href="#cb21-23" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Return</span></span>
<span id="cb21-24"><a href="#cb21-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> ndvi</span>
<span id="cb21-25"><a href="#cb21-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-26"><a href="#cb21-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-27"><a href="#cb21-27" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. Open raster</span></span>
<span id="cb21-28"><a href="#cb21-28" aria-hidden="true" tabindex="-1"></a>results <span class="op">=</span> []</span>
<span id="cb21-29"><a href="#cb21-29" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> rasterio.<span class="bu">open</span>(<span class="st">"data/landsat8_philly.tif"</span>) <span class="im">as</span> src:</span>
<span id="cb21-30"><a href="#cb21-30" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> geom <span class="kw">in</span> gdf_utm.geometry:</span>
<span id="cb21-31"><a href="#cb21-31" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Mask Red (band 4) and NIR (band 5)</span></span>
<span id="cb21-32"><a href="#cb21-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-33"><a href="#cb21-33" aria-hidden="true" tabindex="-1"></a>        masked, mask_transform <span class="op">=</span> mask(</span>
<span id="cb21-34"><a href="#cb21-34" aria-hidden="true" tabindex="-1"></a>            dataset<span class="op">=</span>src,              <span class="co"># The original raster data</span></span>
<span id="cb21-35"><a href="#cb21-35" aria-hidden="true" tabindex="-1"></a>            shapes<span class="op">=</span>[geom],  <span class="co"># The vector geometry we want to crop by</span></span>
<span id="cb21-36"><a href="#cb21-36" aria-hidden="true" tabindex="-1"></a>            crop<span class="op">=</span><span class="va">True</span>,                    <span class="co"># Optional: remove pixels not within boundary</span></span>
<span id="cb21-37"><a href="#cb21-37" aria-hidden="true" tabindex="-1"></a>            all_touched<span class="op">=</span><span class="va">True</span>,             <span class="co"># Optional: get all pixels that touch the boudnary</span></span>
<span id="cb21-38"><a href="#cb21-38" aria-hidden="true" tabindex="-1"></a>            filled<span class="op">=</span><span class="va">False</span>,                 <span class="co"># Optional: do not fill cropped pixels with a default value</span></span>
<span id="cb21-39"><a href="#cb21-39" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb21-40"><a href="#cb21-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-41"><a href="#cb21-41" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Note that the indexing here is zero-based, e.g., band 1 is index 0</span></span>
<span id="cb21-42"><a href="#cb21-42" aria-hidden="true" tabindex="-1"></a>        red <span class="op">=</span> masked[<span class="dv">3</span>]</span>
<span id="cb21-43"><a href="#cb21-43" aria-hidden="true" tabindex="-1"></a>        nir <span class="op">=</span> masked[<span class="dv">4</span>]</span>
<span id="cb21-44"><a href="#cb21-44" aria-hidden="true" tabindex="-1"></a>        ndvi <span class="op">=</span> calculate_NDVI(nir, red)</span>
<span id="cb21-45"><a href="#cb21-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-46"><a href="#cb21-46" aria-hidden="true" tabindex="-1"></a>        <span class="co"># red, _ = rasterio.mask.mask(src, [geom], crop=True, indexes=4)</span></span>
<span id="cb21-47"><a href="#cb21-47" aria-hidden="true" tabindex="-1"></a>        <span class="co"># nir, _ = rasterio.mask.mask(src, [geom], crop=True, indexes=5)</span></span>
<span id="cb21-48"><a href="#cb21-48" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb21-49"><a href="#cb21-49" aria-hidden="true" tabindex="-1"></a>        <span class="co"># red = red.astype(float)</span></span>
<span id="cb21-50"><a href="#cb21-50" aria-hidden="true" tabindex="-1"></a>        <span class="co"># nir = nir.astype(float)</span></span>
<span id="cb21-51"><a href="#cb21-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-52"><a href="#cb21-52" aria-hidden="true" tabindex="-1"></a>        <span class="co"># # Mask out nodata</span></span>
<span id="cb21-53"><a href="#cb21-53" aria-hidden="true" tabindex="-1"></a>        <span class="co"># if src.nodata is not None:</span></span>
<span id="cb21-54"><a href="#cb21-54" aria-hidden="true" tabindex="-1"></a>        <span class="co">#     red[red == src.nodata] = np.nan</span></span>
<span id="cb21-55"><a href="#cb21-55" aria-hidden="true" tabindex="-1"></a>        <span class="co">#     nir[nir == src.nodata] = np.nan</span></span>
<span id="cb21-56"><a href="#cb21-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-57"><a href="#cb21-57" aria-hidden="true" tabindex="-1"></a>        <span class="co"># # NDVI formula (add small epsilon to avoid /0)</span></span>
<span id="cb21-58"><a href="#cb21-58" aria-hidden="true" tabindex="-1"></a>        <span class="co"># ndvi = (nir - red) / (nir + red + 1e-6)</span></span>
<span id="cb21-59"><a href="#cb21-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-60"><a href="#cb21-60" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Flatten and drop NaNs</span></span>
<span id="cb21-61"><a href="#cb21-61" aria-hidden="true" tabindex="-1"></a>        ndvi <span class="op">=</span> ndvi[np.isfinite(ndvi)]</span>
<span id="cb21-62"><a href="#cb21-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-63"><a href="#cb21-63" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Compute stats</span></span>
<span id="cb21-64"><a href="#cb21-64" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> ndvi.size <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb21-65"><a href="#cb21-65" aria-hidden="true" tabindex="-1"></a>            mean_val <span class="op">=</span> <span class="bu">float</span>(ndvi.mean())</span>
<span id="cb21-66"><a href="#cb21-66" aria-hidden="true" tabindex="-1"></a>            min_val <span class="op">=</span> <span class="bu">float</span>(ndvi.<span class="bu">min</span>())</span>
<span id="cb21-67"><a href="#cb21-67" aria-hidden="true" tabindex="-1"></a>            max_val <span class="op">=</span> <span class="bu">float</span>(ndvi.<span class="bu">max</span>())</span>
<span id="cb21-68"><a href="#cb21-68" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb21-69"><a href="#cb21-69" aria-hidden="true" tabindex="-1"></a>            mean_val <span class="op">=</span> min_val <span class="op">=</span> max_val <span class="op">=</span> <span class="va">None</span></span>
<span id="cb21-70"><a href="#cb21-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-71"><a href="#cb21-71" aria-hidden="true" tabindex="-1"></a>        results.append({</span>
<span id="cb21-72"><a href="#cb21-72" aria-hidden="true" tabindex="-1"></a>            <span class="st">"ndvi_mean"</span>: mean_val,</span>
<span id="cb21-73"><a href="#cb21-73" aria-hidden="true" tabindex="-1"></a>            <span class="st">"ndvi_min"</span>: min_val,</span>
<span id="cb21-74"><a href="#cb21-74" aria-hidden="true" tabindex="-1"></a>            <span class="st">"ndvi_max"</span>: max_val</span>
<span id="cb21-75"><a href="#cb21-75" aria-hidden="true" tabindex="-1"></a>        })</span>
<span id="cb21-76"><a href="#cb21-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-77"><a href="#cb21-77" aria-hidden="true" tabindex="-1"></a><span class="co"># 3. Attach results safely</span></span>
<span id="cb21-78"><a href="#cb21-78" aria-hidden="true" tabindex="-1"></a>res_gdf <span class="op">=</span> gpd.GeoDataFrame(results, index<span class="op">=</span>gdf_utm.index)</span>
<span id="cb21-79"><a href="#cb21-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-80"><a href="#cb21-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-81"><a href="#cb21-81" aria-hidden="true" tabindex="-1"></a><span class="co"># Drop old cols if they already exist (prevents overlap error)</span></span>
<span id="cb21-82"><a href="#cb21-82" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> col <span class="kw">in</span> res_gdf.columns:</span>
<span id="cb21-83"><a href="#cb21-83" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> col <span class="kw">in</span> gdf_utm.columns:</span>
<span id="cb21-84"><a href="#cb21-84" aria-hidden="true" tabindex="-1"></a>        gdf_utm <span class="op">=</span> gdf_utm.drop(columns<span class="op">=</span>col)</span>
<span id="cb21-85"><a href="#cb21-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-86"><a href="#cb21-86" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge results</span></span>
<span id="cb21-87"><a href="#cb21-87" aria-hidden="true" tabindex="-1"></a>gdf_utm <span class="op">=</span> gdf_utm.join(res_gdf)</span>
<span id="cb21-88"><a href="#cb21-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-89"><a href="#cb21-89" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(gdf_utm.head())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>         ZillowName                                           geometry  \
0   Academy Gardens  POLYGON ((500127.271 4434899.076, 500464.133 4...   
1           Airport  POLYGON ((483133.506 4415847.15, 483228.716 44...   
2    Allegheny West  POLYGON ((485837.663 4428133.6, 485834.655 442...   
3           Andorra  POLYGON ((480844.652 4435202.29, 480737.832 44...   
4  Aston Woodbridge  POLYGON ((499266.779 4433715.944, 499265.975 4...   

   ndvi_mean  ndvi_min  ndvi_max  
0   0.311035  0.018471  0.582076  
1   0.176434 -0.170573  0.654791  
2   0.221690 -0.055709  0.623701  
3   0.431367  0.038368  0.596069  
4   0.312406  0.029139  0.568488  </code></pre>
</div>
</div>
</section>
<section id="lets-check-our-result-quickly" class="level4" data-number="2.5.3">
<h4 data-number="2.5.3" class="anchored" data-anchor-id="lets-check-our-result-quickly"><span class="header-section-number">2.5.3</span> Let’s check our result quickly</h4>
<div id="cell-39" class="cell" data-execution_count="74">
<details class="code-fold">
<summary>Show Code</summary>
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> matplotlib <span class="im">import</span> pyplot <span class="im">as</span> plt</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Get max value for scaling</span></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>max_val <span class="op">=</span> gdf_utm[<span class="st">"ndvi_mean"</span>].<span class="bu">max</span>()</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>min_val <span class="op">=</span> gdf_utm[<span class="st">"ndvi_mean"</span>].<span class="bu">min</span>()</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot choropleth</span></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>ax <span class="op">=</span> gdf_utm.plot(</span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>    column<span class="op">=</span><span class="st">"ndvi_mean"</span>,       <span class="co"># column to color by</span></span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>    cmap<span class="op">=</span><span class="st">"viridis"</span>,       <span class="co"># colormap</span></span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a>    linewidth<span class="op">=</span><span class="fl">0.8</span>,</span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a>    edgecolor<span class="op">=</span><span class="st">"black"</span>,</span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a>    legend<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a>    vmin<span class="op">=</span>min_val,               <span class="co"># minimum for color scale</span></span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a>    vmax<span class="op">=</span>max_val,         <span class="co"># maximum for color scale</span></span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a>    figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">8</span>)</span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb23-18"><a href="#cb23-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-19"><a href="#cb23-19" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Choropleth Map"</span>, fontsize<span class="op">=</span><span class="dv">14</span>)</span>
<span id="cb23-20"><a href="#cb23-20" aria-hidden="true" tabindex="-1"></a>plt.axis(<span class="st">"off"</span>)</span>
<span id="cb23-21"><a href="#cb23-21" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="week-6B-spatial_fiona_shapely_files/figure-html/cell-17-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>